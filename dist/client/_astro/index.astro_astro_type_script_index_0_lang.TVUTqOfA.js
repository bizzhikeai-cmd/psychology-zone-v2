window.dataLayer=window.dataLayer||[];const y=document.getElementById("date");if(y){const e=new Date;e.setDate(e.getDate()+1);const t=e.toISOString().split("T")[0];y.min=t}let p=!1;const g=document.querySelectorAll("#bookingForm input, #bookingForm select, #bookingForm textarea");g.forEach(e=>{e.addEventListener("focus",()=>{p||(p=!0,window.dataLayer.push({event:"form_start",form_name:"booking_form"}))})});const u=document.getElementById("problem");u&&u.addEventListener("change",e=>{e.target.value&&window.dataLayer.push({event:"form_field_complete",field_name:"problem",field_value:e.target.value})});const f=document.getElementById("date");f&&f.addEventListener("change",()=>{window.dataLayer.push({event:"form_field_complete",field_name:"appointment_date"})});document.querySelectorAll('a[href="#contact"]').forEach(e=>{e.addEventListener("click",()=>{window.dataLayer.push({event:"book_session_click",click_location:e.closest("section")?.id||"header"})})});document.querySelectorAll('a[href^="tel:"]').forEach(e=>{e.addEventListener("click",()=>{window.dataLayer.push({event:"contact_click",contact_type:"phone"})})});document.querySelectorAll('a[href*="wa.me"], [data-track="whatsapp_click"]').forEach(e=>{e.addEventListener("click",()=>{window.dataLayer.push({event:"contact_click",contact_type:"whatsapp"})})});const l=document.getElementById("bookingForm");l&&l.addEventListener("submit",async e=>{e.preventDefault();const t=l.querySelector('button[type="submit"]'),o=document.getElementById("formError"),d={customer_name:document.getElementById("name").value,customer_email:document.getElementById("email").value,customer_phone:document.getElementById("phone").value,city:document.getElementById("city").value,problem:document.getElementById("problem").value,circumstances:document.getElementById("circumstances").value,appointment_date:document.getElementById("date").value,appointment_time:document.getElementById("time").value},_=["customer_name","customer_email","customer_phone","city","problem","circumstances","appointment_date","appointment_time"];for(const a of _)if(!d[a]){o.textContent="Please fill in all required fields",o.style.display="block";return}if(!/^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(d.customer_email)){o.textContent="Please enter a valid email address",o.style.display="block";return}if(d.customer_phone.replace(/\D/g,"").length<10){o.textContent="Please enter a valid phone number",o.style.display="block";return}o.style.display="none";const c=t.textContent;t.textContent="Processing...",t.disabled=!0,window.dataLayer.push({event:"begin_checkout",ecommerce:{currency:"INR",value:599,items:[{item_id:"therapy_session",item_name:"Therapy Session",item_category:d.problem,price:599,quantity:1}]}});try{const a=await fetch("/api/create-order",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(d)}),n=await a.json();if(!a.ok)throw new Error(n.error||"Failed to create order");window.dataLayer.push({event:"payment_initiated",order_id:n.order_id,booking_ref:n.booking_ref});const h={key:n.key_id,amount:n.amount,currency:n.currency,name:"Psychology Zone",description:"Therapy Session Booking",order_id:n.order_id,prefill:n.prefill,notes:{booking_ref:n.booking_ref},theme:{color:"#6b5ce7"},handler:async function(r){t.textContent="Confirming...";try{const i=await fetch("/api/verify-payment",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({razorpay_order_id:r.razorpay_order_id,razorpay_payment_id:r.razorpay_payment_id,razorpay_signature:r.razorpay_signature})}),m=await i.json();if(!i.ok)throw new Error(m.error||"Payment verification failed");window.location.href=`/booking-confirmed?ref=${m.booking_ref}`}catch(i){console.error("Verification error:",i),o.textContent="Payment verification failed. Please contact support.",o.style.display="block",t.textContent=c,t.disabled=!1}},modal:{ondismiss:async function(){window.dataLayer.push({event:"payment_cancelled",order_id:n.order_id});try{await fetch("/api/verify-payment",{method:"PUT",headers:{"Content-Type":"application/json"},body:JSON.stringify({razorpay_order_id:n.order_id,reason:"Payment modal closed by user"})})}catch(r){console.error("Failed to update booking status:",r)}t.textContent=c,t.disabled=!1}}},s=new Razorpay(h);s.on("payment.failed",async function(r){window.dataLayer.push({event:"payment_failed",error_code:r.error.code,error_reason:r.error.reason});try{await fetch("/api/verify-payment",{method:"PUT",headers:{"Content-Type":"application/json"},body:JSON.stringify({razorpay_order_id:n.order_id,reason:`${r.error.code}: ${r.error.reason}`})})}catch(i){console.error("Failed to update booking status:",i)}o.textContent=`Payment failed: ${r.error.description}`,o.style.display="block",t.textContent=c,t.disabled=!1}),s.open()}catch(a){console.error("Order creation error:",a),o.textContent=a.message||"Something went wrong. Please try again.",o.style.display="block",t.textContent=c,t.disabled=!1}});
